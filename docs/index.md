---
title: OpenStackGateway documentation
---
//[OpenStackGateway](index.html)


# OpenStackGateway

Compute provider API for UCloud

## Overview

![Overview](http://www.plantuml.com/plantuml/proxy?cache=no&src=https://raw.githubusercontent.com/aau-claaudia/OpenStackGateway/main/docs/diagrams/overview.iuml)

This service facilitates communication between UCloud and Claaudia OpenStack.
In UCloud terms, this is a compute provider, that provides a compute service to UCloud.
It is a stateless service with an API based on this example:
[UCloud Spring Boot Example](https://github.com/SDU-eScience/UCloud/tree/master/provider-integration/spring-boot-example)

It implements this interface: [JvmProviderSupport](https://github.com/SDU-eScience/UCloud/tree/master/backend/jvm-provider-support) 

See UClouds [Compute Provider Documentation](https://docs.cloud.sdu.dk/dev/backend/app-orchestrator-service/wiki/provider.html#authentication-and-authorization)


## Documentation
[Service documentation on code level](code)

This documentation is generated with [Dokka](https://github.com/Kotlin/dokka):

`./gradlew dokkaGfm`

## Technology
The service is built with Kotlin and Spring Boot. 
It uses the gradle build tool 


## Swagger
The swagger ui can be reached at the base url.
Authentication is enabled, and a Bearer token can be added using the "Authorize" button.
The API can also be tested directly with cURL.
The autogenerated requests for many of the endpoints cannot be shown. 
I have included examples of requests [here](src/test/resources/requests/create-job.json) 
to test the provider API.

For the manual insertion endpoint there is an example [here](src/test/resources/requests/temp-job-request-example.json).

## Athentication and Authorization

UCloud and the provider
This is handled by UClouds provider integration module: [Jvm-Provider-Support](https://github.com/SDU-eScience/UCloud/tree/master/backend/jvm-provider-support)
A certificate and a refresh_token is added to the config and used to authenticate 
the provider integration module on inbound and outbound requests.
See more here: [UCloud Compute Providers](https://github.com/SDU-eScience/UCloud/tree/master/provider-integration/integration-module)

## API

The gateway currently exposes the following endpoints for ucloud:

### Create
Start one or more compute jobs by creating stacks in openstack

One or more jobs are received from ucloud and is assumed to be ready to start.
The ucloud jobs are converted to openstack stack format and sent to openstack.
Without waiting for the stacks to start respond to ucloud.

A monitoring thread is started for each stack that will send a status update to ucloud when you stack has successfully started or failed.

#### Sequence diagram for the create flow

![Overview](http://www.plantuml.com/plantuml/proxy?cache=no&src=https://raw.githubusercontent.com/aau-claaudia/OpenStackGateway/main/docs/diagrams/create-stack-sequence.iuml)

### Delete
Deletes one or more compute jobs by deleting stacks in OpenStack

The corresponding stacks are found in OpenStack and delete requests are sent.

#### Sequence diagram for the delete flow

![Overview](http://www.plantuml.com/plantuml/proxy?cache=no&src=https://raw.githubusercontent.com/aau-claaudia/OpenStackGateway/main/docs/diagrams/delete-stack-sequence.iuml)

### Extend
Todo: Not implemented / Not applicable for virtual machines

### Suspend
Todo: Not implemented

This should suspend the virtual machine without deleting any of its resources
### Verify
Verify UClouds Job status is synchronized with openstack stack status

FIXME: Is this called for deleted ucloud jobs?

This call is periodically executed by UCloud.
The expected status is compared with the actual status in OpenStack and 
a status update is sent if there is a difference.

If the stack could not be found in OpenStack send a status update with Job success to UCloud.
      
The gateway does not attempt to start the stack.
### Retrieve Products
Provide ucloud with the available products. 
These are basically equivalent to openstack flavors but need to adhere to the ucloud format
This includes information additional information, e.g., product is Virtual Machine
### OpenInteractiveSession
Todo: Not implemented

### RetrieveUtilization
Todo: Not implemented

## Scheduled Tasks
Scheduled by the Spring Framework for doing maintenance and job charging

### ChargeAllStacks
Charges the corresponding UCloud job for all active OpenStack stacks.
This is run every 15 minutes and each execution will charge each stack the amount of time since it was last charged.
To keep track of this a timestamp is saved as a tag on the stack in OpenStack.
We only charge stacks that have status: "CREATE_COMPLETE" or "UPDATE_COMPLETE".

- Get the corresponding job from ucloud to make sure it exists, return if not
  - Amount to charge = time between the lastCharged timestamp and now.
- Maintain lastCharged for each stack as a tag on the stack in openstack.
  - lastCharged is the moment the stack was charged last.
- The first time a stack is charged, use its creation time as lastCharged



# Deployment

Todo


# Config

TODO: 
Her skal stå det er vigtigt man sætter Metadata på flavors: Category

# Openstack compute flavors
The general compute flavors are based on deic's type1 descriptions available [somewhere](somewhere).

GPU instances are based on our current hardware,
machines with six t4 GPUs, 256GB memory,
and 64 vCPUs (2x16 core EPYCs).

Storage is based on whatever we did on our old OpenStack platform.

Pricing is just an example

Name | vCPU | RAM | Volatile Storage | GPU | Price
--- | --- | --- | --- | --- | --- 
uc-general-small | 4 vCPU | 16 Gb | 1 Tb | N/A | 0.34 DKK/hour
uc-general-medium | 8 vCPU | 32 Gb | 1 Tb | N/A | 0.68 DKK/hour
uc-general-large | 16 vCPU | 64 Gb | 1 Tb | N/A | 1.37 DKK/hour
uc-general-xlarge | 64 vCPU | 256 Gb | 1 Tb | N/A | 5.50 DKK/hour
uc-t4-1 | 10 vCPU | 40 Gb | 1 Tb | T4 16 Gb | 8.50 DKK/hour
